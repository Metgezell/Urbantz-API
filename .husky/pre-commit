#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# AI Core Protection Hook
# This hook prevents accidental modifications to critical AI integration files
# unless explicitly allowed with [ALLOW_AI_CORE_CHANGE] in commit message

protected_paths="^api/smart-analyze\.js$|^api/analyze-document\.js$|^scripts/local-server\.js$|^ai-core/"

# Check for changes to protected paths
if git diff --cached --name-only | grep -E "$protected_paths"; then
  # Check if commit message contains override flag (from environment or commit message)
  if echo "$HUSKY_GIT_PARAMS" | grep -q "\[ALLOW_AI_CORE_CHANGE\]" || \
     git log -1 --pretty=%B 2>/dev/null | grep -q "\[ALLOW_AI_CORE_CHANGE\]" || \
     [ -z "$(git rev-parse --verify HEAD 2>/dev/null)" ]; then
    echo "‚ö†Ô∏è  AI Core override detected - proceeding with caution"
  else
    echo "‚õî BLOCKED: Changes to AI core files detected!"
    echo ""
    echo "Protected files:"
    echo "  - api/smart-analyze.js"
    echo "  - api/analyze-document.js" 
    echo "  - scripts/local-server.js (AI functions)"
    echo "  - ai-core/ (future directory)"
    echo ""
    echo "To override this protection, add [ALLOW_AI_CORE_CHANGE] to your commit message:"
    echo "  git commit -m 'feat(ai): improve table parsing [ALLOW_AI_CORE_CHANGE]'"
    echo ""
    echo "This protection prevents accidental modifications to your working AI integration."
    exit 1
  fi
fi

# Run linting and tests
echo "üîç Running pre-commit checks..."
npx lint-staged
